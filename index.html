<!doctype html>
<html>
	<head>
		<title>Game</title>
		<style>
html, body
{
    height: 100%;
    width: 100%;
    margin: 0px;
    overflow: hidden;
}
canvas
{
    width: 100%;
    height: 100%;
}		
		</style>
	</head>
	<body style="margin:0px;background-color:navy;">
		<canvas style="background-color:gray;"></canvas>
		<script src="/socket.io/socket.io.js"></script>
		<script
  src="https://code.jquery.com/jquery-3.3.1.js"
  integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60="
  crossorigin="anonymous"></script>
  		<script src="https://scalarfield.github.io/js/tools/memekit.js"></script>
		<script>

class Trail{
	constructor(x, y, xv, yv, size, color, owner){
		this.x = x;
		this.y = y;
		console.log(this.y);
		this.size = this.maxSize = size;
		this.color = color;
		this.xv = xv;
		this.yv = yv;
		this.ya = 1;
		this.lifespan = 100;
		this.age = 0;
		this.imageList = [];
		this.index;
		this.owner = owner;
	}
	
	draw(ctx){
		for(let img of this.imageList){
		ctx.fillStyle = this.color;
		ctx.globalAlpha = (1-img.a/100)/10;
		if(this.age > 100){
			ctx.globalAlpha = ((1-img.a/100)*0.1*(300-this.age)/200)
		}
		ctx.beginPath();
		ctx.arc(img.x, img.y, img.r, 0, 2*Math.PI);
		ctx.fill();
		ctx.closePath(); 
		//console.log(this.age, ctx.globalAlpha);
		}
	}

	update(){
		if(this.age <= 100){
			this.imageList.push( {x:this.x, y:this.y, r:this.size, a:this.age} );
			this.size = this.maxSize * (1-this.age/100);
		}
		this.yv += this.ya;
		this.y += this.yv;
		this.x += this.xv;
		this.age++;
		if(this.age >= 300){
			this.deleteFromList();
		}
	}

	addToList(){
		this.index = trailList.length;
		trailList.push(this);
	}

	deleteFromList(){
		trailList[this.index] = null;
	}

}

c = document.querySelector('canvas');
 let canvasElementStyle = window.getComputedStyle(c);
    c.width = parseInt(canvasElementStyle.width);
	c.height = parseInt(canvasElementStyle.height);
f = c.getContext('2d');

let chargeTimer = 0;
let chargeTime = 150;
let startCharge = false;

let playerList = [];
let trailList = [];
	 		
let socket = io();
socket.on('newplayer', (n)=>{
	console.log(n,"!!!!!");
	playerList[n] = new Player(300, 300, `hsl(${60*n}, 70%, 70%)` );
	console.log(playerList[n]);
});

socket.on('dcplayer', (n)=>{
	playerList[n] = null;
});

socket.on('move', (n)=>{
	let yAngle = n.y;
	if(yAngle > 90){yAngle = 90};
	if(yAngle < -90){yAngle = -90};
	let xAngle = n.x;
	if(xAngle > 90 && xAngle < 180){
		xAngle = 90;
	} else {
		if(xAngle < 360 && xAngle > 180){xAngle -= 360};
		if(xAngle < -90){xAngle = -90};
	}
	if(playerList[n.key] !== null){
		playerList[n.key].y = 300 - yAngle*300/90;
		playerList[n.key].x = 300 - xAngle*300/90;
	}
});

socket.on('chargestart', (n)=>{
	playerList[n].chargeStart = true;
});
			
socket.on('chargestop', (n)=>{
	playerList[n.key].chargeStart = false;
	playerList[n.key].splash();
	playerList[n.key].chargeTime = 0;
	
});
			
class Player{
	constructor(x, y, color){
		this.x = x;
		this.y = y;
		this.color = color;
		this.chargeStart = false;
		this.chargeTimer = 150;
		this.chargeTime = 0;
	}
	update(){
		if(this.chargeStart && this.chargeTime < this.chargeTimer){
			this.chargeTime++;	
		}
	}
	splash(){
	for(let i=0;i<10;i++){
		let power = 5*this.chargeTime/this.chargeTimer;
	//	console.log(power);
		let dx = power - Math.random()*2*power;
		let dy = power - Math.random()*2*power;
		let xv = 3*(power - Math.random()*2*power);
		let yv = 6*(power - Math.random()*2*power);
		let size = power*10;
		console.log(this.y+dy+20);
		(new Trail(this.x+dx+20, this.y+dy+20, xv, yv, size, this.color, this)).addToList();
		console.log(trailList);
	}	
	}
	draw(ctx){
		ctx.fillStyle = this.color;
		ctx.fillRect(this.x, this.y, 40, 40);
		if(this.chargeStart){
			ctx.globalAlpha = 0.2;
			ctx.fillStyle = "black";
			ctx.fillRect(this.x, this.y, 40, 40*this.chargeTime/this.chargeTimer);
			ctx.globalAlpha = 1;
		}
	}
}

function render(){
trailList = trailList.filter((a)=>a!==null);
	for(let i=0;i<trailList.length;i++){
		trailList[i].index = i;
	}
f.globalAlpha = 1;
 f.clearRect(0, 0, 600, 600);
 for(let p of playerList){
	if(p !== null){
		p.update();
		p.draw(f);
	}
 }
	for(let trail of trailList){
		if(trail !== null){
			trail.update();
			trail.draw(f);
		}
	}
}

let loop = setInterval(render, 1000/60);

		</script>
	</body>
</html>
