<!doctype html>
<html>
	<head>
		<title>Game</title>
		<style>
html, body
{
    height: 100%;
    width: 100%;
    margin: 0px;
    overflow: hidden;
}
canvas
{
    width: 100%;
    height: 100%;
}		
		</style>
	</head>
	<body style="margin:0px;background-color:navy;">
		<canvas style="background-color:white;"></canvas>
		<script src="/socket.io/socket.io.js"></script>
		<script
  src="https://code.jquery.com/jquery-3.3.1.js"
  integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60="
  crossorigin="anonymous"></script>
  		<script src="https://scalarfield.github.io/js/tools/memekit.js"></script>
		<script>

class Ball{
	constructor(x, y){
		this.x = x;
		this.y = y;
		this.maxYV = 5;
		this.maxXV = 20;
		this.xv = 0;
		this.yv = 0;
		this.ya = 0.25;
		this.index;
		this.color = "black";
	}
	update(c){
		if(Math.abs(this.yv) < this.maxYV){
			this.yv += this.ya;
		}
		this.y += this.yv;
		this.x += this.xv;
		if(this.x < 0 || this.x > c.width || this.y < 0 || this.y > c.height){
			this.deleteFromList();
		}
	}
	draw(ctx){
		ctx.beginPath();
		ctx.fillStyle = this.color;
		ctx.arc(this.x, this.y, 5, 0, 2*Math.PI);
		ctx.fill();
		ctx.closePath()
	}
	addToList(){
		this.index = ballList.length;
		ballList.push(this);
	}
	deleteFromList(){
		ballList[this.index] = null;
	}
}			
			
class Trail{
	constructor(x, y, xv, yv, size, color, owner){
		this.x = x;
		this.y = y;
		//console.log(this.y);
		this.size = this.maxSize = size;
		this.color = color;
		this.xv = xv;
		this.yv = yv;
		this.ya = 1;
		this.lifespan = 100;
		this.age = 0;
		this.imageList = [];
		this.index;
		this.owner = owner;
	}
	
	draw(ctx){
		for(let img of this.imageList){
		ctx.fillStyle = this.color;
		ctx.globalAlpha = (1-img.a/100)/10;
		if(this.age > 100){
			ctx.globalAlpha = ((1-img.a/100)*0.1*(300-this.age)/200)
		}
		ctx.beginPath();
		ctx.arc(img.x, img.y, img.r, 0, 2*Math.PI);
		ctx.fill();
		ctx.closePath(); 
		//console.log(this.age, ctx.globalAlpha);
		}
	}

	update(){
		if(this.age <= 100){
			this.imageList.push( {x:this.x, y:this.y, r:this.size, a:this.age} );
			this.size = this.maxSize * (1-this.age/100);
			for(let ball of ballList){
				let dx = ball.x - this.x, dy = ball.y - this.y;
				let ds = dx**2 + dy**2;
				if(ds <= this.size**2){
					if(Math.abs(ball.xv) < ball.maxXV){
						ball.xv += Math.sign(this.xv);
					}
					if(Math.abs(ball.yv) < ball.maxYV){
						ball.yv += Math.sign(this.yv);
					}
					ball.color = this.color;
					this.owner.score++;
				}
			}
		}
		this.yv += this.ya;
		this.y += this.yv;
		this.x += this.xv;
		this.age++;
		if(this.age >= 300){
			this.deleteFromList();
		}
	}

	addToList(){
		this.index = trailList.length;
		trailList.push(this);
	}

	deleteFromList(){
		trailList[this.index] = null;
	}

}

c = document.querySelector('canvas');
 let canvasElementStyle = window.getComputedStyle(c);
    c.width = parseInt(canvasElementStyle.width);
	c.height = parseInt(canvasElementStyle.height);
f = c.getContext('2d');

let chargeTimer = 0;
let chargeTime = 150;
let startCharge = false;

let playerList = [];
let trailList = [];
let ballList = [];
			
let ballTimer = 0;
let ballTime = 3;
let time = 0;
	 		
let socket = io();
socket.on('newplayer', (n)=>{
	console.log(n,"!!!!!");
	playerList[n] = new Player(300, 300, `hsl(${60*n}, 70%, 70%)` );
	console.log(playerList[n]);
});

socket.on('dcplayer', (n)=>{
	playerList[n] = null;
});

socket.on('move', (n)=>{
	let yAngle = n.y;
	if(yAngle > 90){yAngle = 90};
	if(yAngle < -90){yAngle = -90};
	let xAngle = n.x;
	if(xAngle > 90 && xAngle < 180){
		xAngle = 90;
	} else {
		if(xAngle < 360 && xAngle > 180){xAngle -= 360};
		if(xAngle < -90){xAngle = -90};
	}
	if(playerList[n.key] !== null){
		playerList[n.key].y = c.height/2 - yAngle*c.height/180;
		playerList[n.key].x = c.width/2 - xAngle*c.width/180;
	}
});

socket.on('chargestart', (n)=>{
	playerList[n].chargeStart = true;
});
			
socket.on('chargestop', (n)=>{
	playerList[n.key].chargeStart = false;
	playerList[n.key].splash();
	playerList[n.key].chargeTime = 0;
	
});
			
class Player{
	constructor(x, y, color){
		this.x = x;
		this.y = y;
		this.color = color;
		this.chargeStart = false;
		this.chargeTimer = 150;
		this.chargeTime = 0;
		this.score = 0;
	}
	update(){
		if(this.chargeStart && this.chargeTime < this.chargeTimer){
			this.chargeTime++;	
		}
	}
	splash(){
	for(let i=0;i<10;i++){
		let power = 5*this.chargeTime/this.chargeTimer;
	//	console.log(power);
		let dx = power - Math.random()*2*power;
		let dy = power - Math.random()*2*power;
		let xv = 3*(power - Math.random()*2*power);
		let yv = 6*(power - Math.random()*2*power);
		let size = power*10;
		//console.log(this.y+dy+20);
		(new Trail(this.x+dx+20, this.y+dy+20, xv, yv, size, this.color, this)).addToList();
		//console.log(trailList);
	}	
	}
	draw(ctx){
		ctx.fillStyle = this.color;
		ctx.fillRect(this.x, this.y, 40, 40);
		if(this.chargeStart){
			ctx.globalAlpha = 0.2;
			ctx.fillStyle = "black";
			ctx.fillRect(this.x, this.y, 40, 40*this.chargeTime/this.chargeTimer);
			ctx.globalAlpha = 1;
		}
	}
}

function render(){
trailList = trailList.filter((a)=>a!==null&&a!==undefined);
	for(let i=0;i<trailList.length;i++){
		trailList[i].index = i;
	}
	ballList = ballList.filter((a)=>a!==null);
	for(let i=0;i<ballList.length;i++){
		ballList[i].index = i;
	}
f.globalAlpha = 1;
 f.clearRect(0, 0, c.width, c.height);
let scoreList = [];
for(let p of playerList){
	if(p !== null){
		scoreList.push({score:p.score, color:p.color});
	}
}
let total = 0;
if(scoreList.length > 0){
	total = scoreList.reduce((a, b)=>a.score+b.score);
}
if(total !== 0){
 let y = 0;
 for(let s of scoreList){
	let h = c.height*s.score/total;
	f.fillStyle = "black";
	f.globalAlpha = 1;
	f.fillRect(0, y, 20, h);
	console.log(y, h);
	y += h;
 }
}
for(let trail of trailList){
		if(trail !== null){
			trail.update();
			trail.draw(f);
		}
	}
f.globalAlpha = 1;
 for(let p of playerList){
	if(p !== null){
		p.update();
		p.draw(f);
	}
 }
	for(let ball of ballList){
		if(ball !== null){
			ball.update(c);
			ball.draw(f);
		}
	}
	ballTimer++;
	time++;
	if(ballTimer >= ballTime){
		ballTimer = 0;
		(new Ball(c.width/2 + Math.cos(time/100)*c.width/2 + 50-Math.random()*100, 0)).addToList();
	}
}

let loop = setInterval(render, 1000/60);

		</script>
	</body>
</html>
